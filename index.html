<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#c96ea2" />
  <title>Hokkaido Travel Book</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root{--bg:#d6efff;--bg2:#f2f8ff;--paper:#f8fbff;--paper-edge:#eef5ff;--line:#c7d9ee;--text:#1f3f6a;--muted:#5b7da5;--pri:#2f74ff;--sec:#7ec8f0}
    *{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(circle at 20% 0%,var(--bg),var(--bg2));color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
    body::before{content:'';position:fixed;inset:0;pointer-events:none;opacity:.09;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.95' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='0.55'/%3E%3C/svg%3E");z-index:0}
    .wrap{max-width:900px;margin:0 auto;padding:16px;position:relative;z-index:1}
    .bg-cover-blur{position:fixed;inset:0;background-image:url('./theme-ref-2.jpg');background-size:cover;background-position:center;filter:blur(14px) saturate(.95);transform:scale(1.06);opacity:.24;z-index:0;pointer-events:none}
    .bg-cover-blur.hidden{display:none}
    .bg-cover-blur::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,248,239,.35),rgba(247,231,212,.55))}
    .book-cover,.book-page{background:linear-gradient(180deg,var(--paper),var(--paper-edge));border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 16px rgba(70,45,25,.08)}
    .book-cover{overflow:hidden}
    .book-cover img{display:block;width:100%;max-height:72vh;object-fit:cover}
    .cover-caption{padding:14px}
    .title{font-family:Inter,sans-serif;font-size:34px;font-weight:800;letter-spacing:.04em;margin:0 0 6px;text-transform:uppercase}
    .subtitle{color:var(--muted);font-size:14px;line-height:1.55}
    .btn{border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:11px 14px;font-size:14px;cursor:pointer;min-height:44px}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .page{padding:20px}
    .swipe-zone{border-radius:10px}
    .date{font-size:12px;color:var(--muted);margin-bottom:8px;letter-spacing:.14em;text-transform:uppercase}
    .chapter{font-family:'Noto Serif KR',serif;font-size:24px;line-height:1.25;margin:0 0 8px}
    .body{line-height:1.78;color:#2b3f5a;font-size:16px;white-space:pre-line}
    .body::first-letter{font-family:'Noto Serif KR',serif;font-size:2.4em;line-height:.9;float:left;margin:.06em .08em 0 0;color:#2f74ff}
    .map-wrap{margin:14px 0;padding:8px;background:#edf6ff;border:1px solid #c7d9ee;border-radius:14px;box-shadow:0 6px 18px rgba(67,120,180,.14)}
    .map-title{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:#5378a3;margin:0 0 6px 2px}
    .map{width:100%;height:250px;border:1px solid var(--line);border-radius:10px;overflow:hidden;margin:0}
    .tagline{display:inline-block;margin:0 0 8px;padding:4px 9px;border-radius:999px;border:1px solid #c7d9ee;background:#f3f9ff;color:#2f74ff;font-size:11px;letter-spacing:.08em;text-transform:uppercase}
    .edit-grid{display:grid;gap:8px;margin:8px 0}
    .input,.textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff;color:var(--text)}
    .textarea{min-height:120px;resize:vertical;line-height:1.6}
    .details-wrap{margin-top:12px}
    .details-scroll{display:flex;gap:0;overflow-x:auto;scroll-snap-type:x mandatory;scroll-behavior:smooth;border-radius:12px}
    .details-scroll::-webkit-scrollbar{display:none}
    .detail-card{min-width:100%;max-width:100%;border:1px dashed var(--line);border-radius:12px;padding:14px;background:linear-gradient(180deg,#fffdf9,#fff7ee);scroll-snap-align:start;box-shadow:inset 0 0 0 1px rgba(255,255,255,.45)}
    .detail-card h3{margin:0 0 8px;font-size:13px;letter-spacing:.08em;text-transform:uppercase;color:#2b3f5a}
    .detail-card ul{margin:0;padding-left:20px}
    .detail-card li{margin:8px 0;line-height:1.5}
    .spot-row{padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .spot-name{font-weight:600;color:#24374f;margin-bottom:6px}
    .spot-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill-link{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;text-decoration:none;color:#2b3f5a;font-size:12px;min-height:32px}
    .pill-link.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .pill-link.soft{background:#eef5fb;border-color:#d6e6f4;color:#2e7aa9}
    .details-status{margin-top:8px}
    .details-bar{height:6px;border-radius:999px;background:#eadfce;overflow:hidden}
    .details-bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--sec),var(--pri));transition:width .2s ease}
    .details-label{margin-top:4px;font-size:12px;color:var(--muted);text-align:center}
    .book-nav{display:flex;gap:8px;margin-top:16px}
    .book-nav .btn{flex:1}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    .book-page{transform-origin:left center;backface-visibility:hidden;touch-action:pan-y}
    @keyframes pageFlipNext{0%{opacity:.6;transform:perspective(1200px) rotateY(-24deg) translateX(-12px)}100%{opacity:1;transform:perspective(1200px) rotateY(0deg) translateX(0)}}
    @keyframes pageFlipPrev{0%{opacity:.6;transform:perspective(1200px) rotateY(24deg) translateX(12px)}100%{opacity:1;transform:perspective(1200px) rotateY(0deg) translateX(0)}}
    .book-page.flip-next{animation:pageFlipNext .35s ease}
    .book-page.flip-prev{animation:pageFlipPrev .35s ease}
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <div id="bg-cover-blur" class="bg-cover-blur hidden" aria-hidden="true"></div>
  <main class="wrap" id="content"></main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(async function clearPwaCache(){
  if('serviceWorker' in navigator){
    const regs = await navigator.serviceWorker.getRegistrations();
    for(const r of regs) await r.unregister();
  }
  if('caches' in window){
    const keys = await caches.keys();
    await Promise.all(keys.map(k=>caches.delete(k)));
  }
})();

let showCover = true;
let currentPage = 0;
let flipDir = 'next';
let currentMap = null;
let isEditing = false;
const PAGE_STORE_KEY = 'hokkaido-book-pages-v1';
let detailsAutoTimer = null;

const swipeState = {
  startX: 0,
  startY: 0,
  dx: 0,
  dy: 0,
  active: false,
  locked: false
};

const pages = [
  {
    date:'4/27(ì›”)',
    chapter:'Chapter 1. ì„¤ì›ì˜ ë„ì°©',
    text:`ì¸ì²œì—ì„œ ì¶œë°œí•œ ë¹„í–‰ê¸°ëŠ” ì˜¤í›„ì˜ ë¹›ì„ ë”°ë¼ ì‹ ì¹˜í† ì„¸ì— ë‚´ë ¤ì•‰ëŠ”ë‹¤.
ë Œí„°ì¹´ë¥¼ ì°¾ì•„ ì‹œë¼ì˜¤ì´ë¡œ í–¥í•˜ëŠ” ê¸¸, ì°½ë°–ì€ ì ì  í•˜ì–—ê³  ê³ ìš”í•´ì§„ë‹¤.
ì˜¤ëŠ˜ì€ ë©€ë¦¬ ê°€ì§€ ì•ŠëŠ”ë‹¤. ì²œì²œíˆ, ì—¬í–‰ì˜ ì˜¨ë„ë¥¼ ë§ì¶”ëŠ” ë‚ .`,
    details:['KE769 12:35-15:20', 'ë ŒíŠ¸ì¹´ í”½ì—… 15:30', 'ì¹´ì´ í¬ë¡œí†  ì²´í¬ì¸ & ë””ë„ˆ'],
    spots:[
      {name:'New Chitose Airport (CTS)',lat:42.7752,lng:141.6923},
      {name:'Hoshino Resorts KAI Poroto',lat:42.5513,lng:141.3577}
    ]
  },
  {
    date:'4/28(í™”)',
    chapter:'Chapter 2. ë‚¨ìª½ìœ¼ë¡œ ë‚´ë ¤ê°€ëŠ” ê¸¸',
    text:`ì‹œë¼ì˜¤ì´ì—ì„œ í•˜ì½”ë‹¤í…Œê¹Œì§€ëŠ” ê¸´ í˜¸í¡ì˜ ì´ë™ì´ë‹¤.
ê¸‰í•˜ê²Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì§€ìš°ê¸°ë³´ë‹¤, ì‰¬ê³  í’ê²½ì„ ë³´ëŠ” ë‚ .
ì•„ì¹´ë Œì¹´ ì°½ê³ ì— ë‹¿ìœ¼ë©´ ë„ì‹œì˜ ê²°ì´ ë‹¬ë¼ì§„ë‹¤.`,
    details:['ì²´í¬ì•„ì›ƒ 12:00', 'ì¥ê±°ë¦¬ ì´ë™(ì•½ 3~4ì‹œê°„)', 'ìˆ™ì†Œ ì²´í¬ì¸ í›„ ì €ë… ìœ ë™ ìš´ì˜'],
    spots:[
      {name:'KAI Poroto',lat:42.5513,lng:141.3577},
      {name:'Kanemori Red Brick Warehouse',lat:41.7674,lng:140.7147},
      {name:'Chikuba Shinyotei Ryokan',lat:41.7803,lng:140.7875}
    ]
  },
  {
    date:'4/29(ìˆ˜)',
    chapter:'Chapter 3. í•˜ì½”ë‹¤í…Œì˜ í•˜ë£¨',
    text:`ì•„ì¹¨ì‹œì¥ë¶€í„° ê³ ë£Œì¹´ì¿ , ì¹´í˜, í•˜ì¹˜ë§Œìì¹´ì™€ ì•¼ê²½ê¹Œì§€.
ë§ì´ ë³´ê¸°ë³´ë‹¤ ë¦¬ë“¬ì„ ì§€í‚¤ëŠ” ê²Œ í•µì‹¬.
í•˜ë£¨ì˜ ì™„ì„±ì€ ëª…ì†Œ ê°œìˆ˜ê°€ ì•„ë‹ˆë¼, ëª¨ë‘ê°€ ëœ ì§€ì¹œ ì–¼êµ´ë¡œ ëŒì•„ì˜¤ëŠ” ê²ƒ.`,
    details:['ì•„ì¹¨ì‹œì¥ â†’ ê³ ë£Œì¹´ì¿  ì¤‘ì‹¬', 'ì¹´í˜ì—ì„œ ë‚®ì  íƒ€ì„ í™•ë³´', 'ì•¼ê²½ì€ ì»¨ë””ì…˜ ë³´ê³  ê²°ì •'],
    spots:[
      {name:'Hakodate Morning Market',lat:41.7736,lng:140.7275},
      {name:'Goryokaku Park',lat:41.7968,lng:140.7575},
      {name:'Hachimanzaka Slope',lat:41.7657,lng:140.7100},
      {name:'Mt. Hakodate Ropeway',lat:41.7592,lng:140.7030}
    ]
  },
  {
    date:'4/30(ëª©)',
    chapter:'Chapter 4. ì˜¨ì²œìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” í˜ì´ì§€',
    text:`í•˜ì½”ë‹¤í…Œì˜ ì•„ì¹¨ì„ ê°€ë³ê²Œ ë§ˆë¬´ë¦¬í•˜ê³  ë…¸ë³´ë¦¬ë² ì¸ ë¡œ ì´ë™.
ê¸¸ ìœ„ì—ì„œ ìš•ì‹¬ì„ ëœë©´, ë„ì°© í›„ì˜ ì‹œê°„ì´ ê¸¸ì–´ì§„ë‹¤.
ì˜¤ëŠ˜ì€ ì›€ì§ì„ë³´ë‹¤ íšŒë³µì˜ ë‚ .`,
    details:['ì²´í¬ì•„ì›ƒ 11:00', 'ì ì‹¬ í›„ ë…¸ë³´ë¦¬ë² ì¸  ì´ë™', 'ì˜¨ì²œ & íœ´ì‹ ì¤‘ì‹¬ ìš´ì˜'],
    spots:[
      {name:'Uni Murakami Hakodate Honten',lat:41.7733,lng:140.7258},
      {name:'Noboribetsu Hanayura',lat:42.4987,lng:141.1446}
    ]
  },
  {
    date:'5/1(ê¸ˆ)',
    chapter:'Chapter 5. ê·€êµ­ ì „ì˜ ìˆ¨',
    text:`ì²´í¬ì•„ì›ƒ í›„ ì§€ì˜¥ê³„ê³¡ì„ ì§§ê²Œ ê±·ê³  ê³µí•­ìœ¼ë¡œ í–¥í•œë‹¤.
ë§ˆì§€ë§‰ ë‚ ì€ í•­ìƒ ê°€ì¥ ë¹¨ë¦¬ ì§€ë‚˜ê°„ë‹¤.
ì´ë²ˆ ì—¬í–‰ì˜ ëª©í‘œëŠ” â€˜ë§ì´ ë³¸ ê²ƒâ€™ì´ ì•„ë‹ˆë¼ â€˜í•¨ê»˜ ë¬´ë¦¬ ì—†ì´ ì˜ ë‹¤ë…€ì˜¨ ê²ƒâ€™.`,
    details:['ì²´í¬ì•„ì›ƒ 10:00', 'ì§€ì˜¥ê³„ê³¡ ì§§ì€ ì‚°ì±…', 'ê³µí•­ ë°˜ë‚© í›„ KE766 15:05-18:10'],
    spots:[
      {name:'Noboribetsu Hanayura',lat:42.4987,lng:141.1446},
      {name:'Noboribetsu Jigokudani',lat:42.4973,lng:141.1428},
      {name:'New Chitose Airport (CTS)',lat:42.7752,lng:141.6923}
    ]
  }
];

function loadEdits(){
  try{
    const raw = localStorage.getItem(PAGE_STORE_KEY);
    if(!raw) return;
    const saved = JSON.parse(raw);
    saved.forEach((s,idx)=>{
      if(!pages[idx] || typeof s !== 'object') return;
      if(typeof s.chapter === 'string') pages[idx].chapter = s.chapter;
      if(typeof s.text === 'string') pages[idx].text = s.text;
      if(Array.isArray(s.details)) pages[idx].details = s.details;
    });
  }catch{}
}

function persistEdits(){
  const payload = pages.map(p=>({chapter:p.chapter,text:p.text,details:p.details||[]}));
  localStorage.setItem(PAGE_STORE_KEY, JSON.stringify(payload));
}

function renderDetails(page){
  const details = (page.details && page.details.length ? page.details : ['ìƒì„¸ í•­ëª© ì—†ìŒ'])
    .map(d=>`<li>ğŸ“ ${d}</li>`).join('');

  const spots = page.spots.map((s,idx)=>{
    const nav = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=driving`;
    const map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.name)}`;
    return `<li class="spot-row"><div class="spot-name">ğŸ“ ${idx+1}. ${s.name}</div><div class="spot-actions"><a class="pill-link pri" href="${nav}" target="_blank">ğŸš— ë„¤ë¹„ ì‹œì‘</a><a class="pill-link soft" href="${map}" target="_blank">ğŸ—º ì§€ë„ ë³´ê¸°</a></div></li>`;
  }).join('');

  const center = page.spots?.[0] || {lat:42.7752,lng:141.6923,name:'í˜„ì¬ ë™ì„  ì¤‘ì‹¬'};
  const nearby = [
    {emoji:'ğŸª',label:'í¸ì˜ì ',q:'convenience store near ' + center.name},
    {emoji:'ğŸš»',label:'í™”ì¥ì‹¤',q:'public toilet near ' + center.name},
    {emoji:'â˜•',label:'ì¹´í˜',q:'cafe near ' + center.name},
    {emoji:'ğŸ¼',label:'ì•„ê¸°ìš©í’ˆ',q:'baby supplies near ' + center.name},
    {emoji:'â›½',label:'ì£¼ìœ ì†Œ',q:'gas station near ' + center.name}
  ].map(n=>`<li>${n.emoji} <a class="pill-link" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n.q)}">${n.label} ì°¾ê¸°</a></li>`).join('');

  const restaurants = [
    {emoji:'ğŸ£',label:'ì¼ì‹ ë§›ì§‘',q:'best japanese restaurant near ' + center.name},
    {emoji:'ğŸœ',label:'ë¼ë©˜',q:'ramen near ' + center.name},
    {emoji:'ğŸ¦€',label:'í•´ì‚°ë¬¼',q:'seafood restaurant near ' + center.name},
    {emoji:'ğŸ¥©',label:'ì§•ê¸°ìŠ¤ì¹¸',q:'jingisukan near ' + center.name},
    {emoji:'ğŸ°',label:'ë””ì €íŠ¸/ë² ì´ì»¤ë¦¬',q:'dessert bakery near ' + center.name}
  ].map(n=>`<li>${n.emoji} <a class="pill-link soft" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n.q)}">${n.label} ì°¾ê¸°</a></li>`).join('');

  return `
    <section class="details-wrap" aria-label="ìƒì„¸ ì •ë³´ ê°€ë¡œ ìŠ¤í¬ë¡¤">
      <div id="details-scroll" class="details-scroll">
        <article class="detail-card" data-card-index="0">
          <h3>ğŸ“š ì˜¤ëŠ˜ì˜ ìƒì„¸ ì •ë³´</h3>
          <ul>${details}</ul>
        </article>
        <article class="detail-card" data-card-index="1">
          <h3>ğŸ§­ ë°©ë¬¸ í¬ì¸íŠ¸</h3>
          <ul>${spots}</ul>
        </article>
        <article class="detail-card" data-card-index="2">
          <h3>ğŸ§· ì£¼ë³€ í¸ì˜ì‹œì„¤</h3>
          <ul>${nearby}</ul>
        </article>
        <article class="detail-card" data-card-index="3">
          <h3>ğŸ½ï¸ ì£¼ë³€ ë§›ì§‘</h3>
          <ul>${restaurants}</ul>
        </article>
      </div>
      <div class="details-status" aria-live="polite">
        <div class="details-bar"><i id="details-bar-fill"></i></div>
        <div id="details-label" class="details-label">1 / 4 ì¹´ë“œ</div>
      </div>
    </section>`;
}

function render(){
  const root = document.getElementById('content');
  const bg = document.getElementById('bg-cover-blur');
  if(bg) bg.classList.toggle('hidden', showCover);
  if(detailsAutoTimer){ clearInterval(detailsAutoTimer); detailsAutoTimer = null; }
  if(showCover){ 
    root.innerHTML = `
      <section class="book-cover">
        <img src="./theme-ref-2.jpg" alt="ì—¬í–‰ ì±… í‘œì§€"/>
        <div class="cover-caption">
          <h1 class="title">Hokkaido Travel Book</h1>
          <div class="subtitle">í˜ì´ì§€ë¥¼ ë„˜ê¸°ë©´ ë‚ ì§œë³„ ì´ì•¼ê¸°ì™€ ë™ì„  ì§€ë„ê°€ í•¨ê»˜ í¼ì³ì§„ë‹¤.</div>
          <div class="book-nav" style="margin-top:12px">
            <button class="btn pri" onclick="startBook()" aria-label="ì±… í¼ì¹˜ê¸°">ì±… í¼ì¹˜ê¸°</button>
          </div>
        </div>
      </section>`;
    return;
  }

  const page = pages[currentPage];
  const flipClass = flipDir === 'prev' ? 'flip-prev' : 'flip-next';
  const detailsText = (page.details||[]).join('\n');
  root.innerHTML = `
    <section class="book-page ${flipClass}">
      <div class="page">
        <div id="swipe-zone" class="swipe-zone" aria-label="í˜ì´ì§€ ì „í™˜ ì œìŠ¤ì²˜ ì˜ì—­">
          <div class="date">${page.date}</div>
          <div class="tagline">Hokkaido Editorial Route</div>
          ${isEditing ? `
            <div class="edit-grid">
              <input id="edit-chapter" class="input" value="${page.chapter.replace(/"/g,'&quot;')}" />
              <textarea id="edit-text" class="textarea">${page.text}</textarea>
              <textarea id="edit-details" class="textarea" placeholder="ìƒì„¸ì •ë³´ í•œ ì¤„ì”© ì…ë ¥">${detailsText}</textarea>
              <button class="btn pri" onclick="saveCurrentPageEdits()">ì´ í˜ì´ì§€ ì €ì¥</button>
            </div>
          ` : `
            <h2 class="chapter">${page.chapter}</h2>
            <div class="body">${page.text}</div>
          `}
        </div>
        <div class="map-wrap">
          <div class="map-title">Route Map Â· Day ${currentPage + 1}</div>
          <div id="map" class="map" aria-label="${page.date} ë™ì„  ì§€ë„"></div>
        </div>
        ${renderDetails(page)}
        <div class="small">${currentPage + 1} / ${pages.length} í˜ì´ì§€</div>
        <div class="book-nav">
          <button class="btn" onclick="${currentPage===0?'goCover()':'prevPage()'}" aria-label="${currentPage===0?'ì±… íƒ€ì´í‹€ë¡œ ì´ë™':'ì´ì „ í˜ì´ì§€'}">${currentPage===0?'â† ì±… íƒ€ì´í‹€':'â† ì´ì „ í˜ì´ì§€'}</button>
          <button class="btn" onclick="toggleEdit()" aria-label="ì œëª©/ì„¤ëª… ìˆ˜ì •">${isEditing ? 'í¸ì§‘ ì™„ë£Œ' : 'ì œëª©/ì„¤ëª… ìˆ˜ì •'}</button>
          <button class="btn pri" onclick="nextPage()" ${currentPage===pages.length-1?'disabled':''} aria-label="ë‹¤ìŒ í˜ì´ì§€">ë‹¤ìŒ í˜ì´ì§€ â†’</button>
        </div>
      </div>
    </section>`;
  bindSwipeGesture();
  setTimeout(mountMap, 0);
  setTimeout(bindDetailsCarousel, 0);
}

function bindDetailsCarousel(){
  if(detailsAutoTimer){ clearInterval(detailsAutoTimer); detailsAutoTimer = null; }
  const scroller = document.getElementById('details-scroll');
  const bar = document.getElementById('details-bar-fill');
  const label = document.getElementById('details-label');
  if(!scroller || !bar || !label) return;

  const total = scroller.querySelectorAll('.detail-card').length || 1;

  function getIndex(){
    const width = scroller.clientWidth || 1;
    return Math.max(0, Math.min(total-1, Math.round(scroller.scrollLeft / width)));
  }

  function updateStatus(){
    const idx = getIndex();
    const pct = ((idx + 1) / total) * 100;
    bar.style.width = `${pct}%`;
    label.textContent = `${idx + 1} / ${total} ì¹´ë“œ`;
  }

  function scrollToIndex(idx){
    const width = scroller.clientWidth || 1;
    scroller.scrollTo({left: width * idx, behavior:'smooth'});
  }

  scroller.addEventListener('scroll', updateStatus, {passive:true});
  updateStatus();

  detailsAutoTimer = setInterval(()=>{
    const idx = getIndex();
    const next = (idx + 1) % total;
    scrollToIndex(next);
  }, 5200);
}

function bindSwipeGesture(){
  const pageEl = document.getElementById('swipe-zone');
  if(!pageEl) return;

  pageEl.addEventListener('touchstart', onTouchStart, {passive:true});
  pageEl.addEventListener('touchmove', onTouchMove, {passive:true});
  pageEl.addEventListener('touchend', onTouchEnd, {passive:true});
  pageEl.addEventListener('touchcancel', resetSwipeState, {passive:true});
}

function onTouchStart(e){
  if(showCover || isEditing) return;
  if(!e.touches || e.touches.length !== 1){ resetSwipeState(); return; }
  const t = e.touches[0];
  swipeState.startX = t.clientX;
  swipeState.startY = t.clientY;
  swipeState.dx = 0;
  swipeState.dy = 0;
  swipeState.active = true;
  swipeState.locked = false;
}

function onTouchMove(e){
  if(!swipeState.active || !e.touches || e.touches.length !== 1) return;
  const t = e.touches[0];
  swipeState.dx = t.clientX - swipeState.startX;
  swipeState.dy = t.clientY - swipeState.startY;

  // ìˆ˜ì§ ìŠ¤í¬ë¡¤/ê¸°íƒ€ ì œìŠ¤ì²˜ëŠ” ë¬´ì‹œ
  if(Math.abs(swipeState.dy) > Math.abs(swipeState.dx)) swipeState.locked = true;
}

function onTouchEnd(){
  if(!swipeState.active) return;

  const absX = Math.abs(swipeState.dx);
  const absY = Math.abs(swipeState.dy);
  const MIN_SWIPE_X = 56;
  const MAX_SWIPE_Y = 42;

  // ë‹¤ë¥¸ ì´ë²¤íŠ¸(ì§§ì€ í„°ì¹˜/ìˆ˜ì§/ëŒ€ê°ì„ /ë©€í‹°í„°ì¹˜)ëŠ” ë¬´ì‹œ
  if(!swipeState.locked && absX >= MIN_SWIPE_X && absY <= MAX_SWIPE_Y){
    if(swipeState.dx < 0) nextPage();
    else prevPage();
  }

  resetSwipeState();
}

function resetSwipeState(){
  swipeState.startX = 0;
  swipeState.startY = 0;
  swipeState.dx = 0;
  swipeState.dy = 0;
  swipeState.active = false;
  swipeState.locked = false;
}

function mountMap(){
  const page = pages[currentPage];
  if(currentMap){ currentMap.remove(); currentMap = null; }
  const mapEl = document.getElementById('map');
  if(!mapEl || !page?.spots?.length) return;

  const map = L.map(mapEl,{zoomControl:true});
  currentMap = map;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);

  const latlngs = page.spots.map(s=>[s.lat,s.lng]);
  page.spots.forEach((s,idx)=>{
    const num = idx+1;
    const icon = L.divIcon({className:'',html:`<div style="width:28px;height:28px;border-radius:50%;background:#2e7aa9;border:2px solid #fff;color:#fff;font:700 12px Inter;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 7px rgba(46,122,169,.35)">${num}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
    const nav = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=driving`;
    L.marker([s.lat,s.lng],{icon}).addTo(map).bindPopup(`<b>${num}. ${s.name}</b><br><a href="${nav}" target="_blank">ë„¤ë¹„ ì‹œì‘</a>`);
  });

  if(latlngs.length>=2) L.polyline(latlngs,{color:'#2e7aa9',weight:4,opacity:.92}).addTo(map);
  map.fitBounds(L.latLngBounds(latlngs),{padding:[24,24]});
}

function toggleEdit(){ isEditing = !isEditing; render(); }

function saveCurrentPageEdits(){
  const chapter = document.getElementById('edit-chapter')?.value?.trim();
  const text = document.getElementById('edit-text')?.value?.trim();
  const detailsRaw = document.getElementById('edit-details')?.value || '';
  if(chapter) pages[currentPage].chapter = chapter;
  if(text) pages[currentPage].text = text;
  pages[currentPage].details = detailsRaw.split('\n').map(v=>v.trim()).filter(Boolean);
  persistEdits();
  isEditing = false;
  render();
}

function startBook(){ showCover = false; render(); }
function goCover(){ showCover = true; isEditing = false; render(); }
function prevPage(){ if(currentPage===0) return; flipDir='prev'; isEditing=false; currentPage--; render(); }
function nextPage(){ if(currentPage===pages.length-1) return; flipDir='next'; isEditing=false; currentPage++; render(); }

window.toggleEdit = toggleEdit;
window.saveCurrentPageEdits = saveCurrentPageEdits;
window.startBook = startBook;
window.goCover = goCover;
window.prevPage = prevPage;
window.nextPage = nextPage;

loadEdits();
render();
</script>
</body>
</html>