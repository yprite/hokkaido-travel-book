<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#cfd3d8" />
  <title>SAPPORO Â· Editorial Book</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root{--bg:#d9dbe0;--paper:#ffffff;--ink:#2f3b4b;--muted:#6f7d90;--line:#e2e7ee;--pri:#5f9ed0}
    *{box-sizing:border-box}
    html,body{margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink);overflow-x:hidden}
    .bg{position:fixed;inset:0;background:linear-gradient(180deg,#d8dce2,#eceff4);z-index:0;pointer-events:none}
    .wrap{width:100%;max-width:980px;margin:0 auto;padding:22px;position:relative;z-index:1}

    .book{background:var(--paper);border:1px solid var(--line);border-radius:10px;box-shadow:0 12px 30px rgba(20,26,38,.18)}

    .cover-shell{display:grid;place-items:center;padding:26px;min-height:78vh}
    .cover-book{width:min(520px,92%);background:#f7fbff;border-radius:8px;box-shadow:0 18px 32px rgba(0,0,0,.22);overflow:hidden;border:1px solid #d8e4f1}
    .cover-book img{width:100%;display:block;aspect-ratio:3/4;object-fit:cover}
    .cover-body{padding:16px 18px 18px}
    .kicker{font-size:11px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
    h1{margin:8px 0 6px;font-size:42px;line-height:1.02;letter-spacing:.02em}
    .sub{font-size:14px;color:var(--muted)}

    .btn{min-height:44px;border-radius:10px;border:1px solid var(--line);padding:10px 14px;background:#fff;color:var(--ink);font-weight:600;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff;border-color:var(--pri)}
    .nav{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:14px}

    .spread{padding:14px;position:relative;overflow:hidden}
    .spread::before{content:'';position:absolute;inset:14px 50% 14px 50%;width:1px;background:linear-gradient(180deg,transparent,#dbe3ec 10%,#dbe3ec 90%,transparent);z-index:0}
    .spread-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;position:relative;z-index:1}
    .page-left,.page-right{border:1px solid var(--line);border-radius:6px;padding:14px;background:#fff;min-height:560px;min-width:0}

    .date{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .title{font-size:30px;line-height:1.1;margin:8px 0 10px;font-weight:800;overflow-wrap:anywhere}
    .body{font-size:16px;line-height:1.85;color:#3f5166;white-space:pre-line;overflow-wrap:anywhere}
    .sublead{font-size:22px;line-height:1.25;font-weight:700;color:#4b85b6;margin:0 0 8px}
    .body-rest{font-size:16px;line-height:1.82;color:#3f5166;white-space:pre-line}

    .map-label{margin:10px 0 6px;font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}
    .map{height:200px;border-radius:6px;overflow:hidden;border:1px solid #d7e3ef}
    .folio{margin-top:10px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between}

    .meta-list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:6px}
    .meta-item{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#f8fbff;font-size:13px;line-height:1.45;color:#3f5166;overflow-wrap:anywhere}
    .meta-item strong{color:#2d4259}
    .meta-item-btn{width:100%;text-align:left;border:0;background:transparent;color:inherit;padding:0;margin:0;font:inherit;cursor:pointer}
    .meta-item-btn .hint{display:inline-block;margin-left:6px;font-size:11px;color:#5f9ed0}

    .food-panel{margin-top:12px;border-top:1px solid var(--line);padding-top:10px}
    .food-title{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px}
    .food-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
    .food-card{min-width:220px;border:1px solid var(--line);border-radius:8px;padding:10px;background:#fff}
    .food-card h4{margin:0 0 6px;font-size:14px}
    .food-card p{margin:3px 0;font-size:12px;color:#586b80;line-height:1.4;overflow-wrap:anywhere}

    .edit{margin-top:10px;font-size:12px;color:var(--muted)}
    .flip-next{animation:flipNext .35s ease}
    .flip-prev{animation:flipPrev .35s ease}
    .swipe-zone{touch-action:pan-y;position:relative;overflow:hidden;border:1px solid #d7e3ef;border-radius:8px;padding:12px;--panel-bg:none;background:#f9fcff}
    .swipe-zone::before{content:'';position:absolute;inset:0;background-image:var(--panel-bg);background-size:cover;background-position:center;filter:saturate(.95) contrast(.95);opacity:.80;z-index:0;transform:scale(1.03)}
    .swipe-zone::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.45),rgba(255,255,255,.62));z-index:0}
    .swipe-zone > *{position:relative;z-index:1}

    @keyframes flipNext{0%{opacity:.65;transform:perspective(1200px) rotateY(-16deg) translateX(-8px)}100%{opacity:1;transform:perspective(1200px) rotateY(0) translateX(0)}}
    @keyframes flipPrev{0%{opacity:.65;transform:perspective(1200px) rotateY(16deg) translateX(8px)}100%{opacity:1;transform:perspective(1200px) rotateY(0) translateX(0)}}

    @media (max-width:860px){
      .wrap{padding:12px}
      .spread{padding:10px}
      .spread::before{display:none}
      .spread-grid{grid-template-columns:1fr}
      .page-left,.page-right{min-height:auto}
    }
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
<div id="bg" class="bg"></div>
<main class="wrap" id="app"></main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
let cover=true, i=0, dir='next', map=null;
let markers=[];
const swipe={x:0,y:0,dx:0,dy:0,a:false,lock:false};

const pages=[
  {date:'4/27 MON', title:'ì¸ì²œ â†’ CTS â†’ ì‹œë¼ì˜¤ì´', text:`ì…êµ­Â·ë ŒíŠ¸Â·ì²´í¬ì¸ ì¤‘ì‹¬ì˜ ì²«ë‚ .
ë™ì„ ì„ ì§§ê²Œ ì¡ê³  ë£Œì¹¸ ë””ë„ˆë¡œ ë§ˆë¬´ë¦¬.`, hero:'./day1-hero.jpg', meta:['KE769 12:35-15:20','ë ŒíŠ¸ì¹´ í”½ì—… 15:30','í˜¸ì‹œë…¸ ë¦¬ì¡°íŠ¸ ì¹´ì´ í¬ë¡œí†  ì²´í¬ì¸ 15:00+','ì €ë…: ê°€ì´ì„¸í‚¤'], spots:[['Incheon',37.4602,126.4407],['CTS',42.7752,141.6923],['KAI Poroto',42.5513,141.3577]]},
  {date:'4/28 TUE', title:'ì‹œë¼ì˜¤ì´ â†’ í•˜ì½”ë‹¤í…Œ', text:`ì¥ê±°ë¦¬ ì´ë™ì¼.
íœ´ê²Œì†Œ ì ì‹¬ê³¼ ì²´í¬ì¸ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì—¬ìœ  ìˆê²Œ ì´ë™.`, hero:'./day2-hero-new.jpg', meta:['ì•„ì¹¨: í˜¸ì‹œë…¸ ë¦¬ì¡°íŠ¸ ì¼ì‹','ì¹´ì´ í¬ë¡œí†  ì²´í¬ì•„ì›ƒ 12:00','ì´ë™ ì•½ 3~4ì‹œê°„','ì•„ì¹´ë Œì¹´ ì°½ê³ ','ì¹˜ì¿ ë°” ì‹ ìš”í…Œì´ ì²´í¬ì¸ 15:00+','ì €ë…: ì´ì´ë‹¤ì•¼ ë˜ëŠ” ìŠ¤í‚¤ì•¼í‚¤ ì•„ì‚¬ë¦¬'], spots:[['KAI Poroto',42.5513,141.3577],['Kanemori Red Brick',41.7674,140.7147],['Chikuba Shinyotei',41.7803,140.7875]]},
  {date:'4/29 WED', title:'í•˜ì½”ë‹¤í…Œ ë°ì´', text:`ì•„ì¹¨ì‹œì¥ë¶€í„° ì•¼ê²½ê¹Œì§€ í•µì‹¬ ë£¨íŠ¸ë¥¼ í•˜ë£¨ì— ë‹´ë˜,
ì»¨ë””ì…˜ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ì¶•ì†Œ ê°€ëŠ¥í•œ êµ¬ì„±.`, hero:'./day2-hero.jpg', meta:['í•˜ì½”ë‹¤í…Œ ì•„ì¹¨ì‹œì¥ + ì°¨ë¬´(ì¹´ì´ì„¼ë™)','ê³ ë£Œì¹´ì¿  ë²šê½ƒ','ì¹´í˜: ë¡¯í…Œì¹´ì´/í”¼ë² ë¦¬','ì ì‹¬: í†¤í‚¤ ë‹¤ì´ëª¬ì  ë˜ëŠ” íƒ€ì¹´í•˜ì‹œ(ì¥ì–´)','í•˜ì¹˜ë§Œìì¹´ ì–¸ë•','í•˜ì½”ë‹¤í…Œì•¼ë§ˆ ë¡œí”„ì›¨ì´ ì•¼ê²½','T/O: ëŸ­í‚¤ì‚ì—ë¡œÂ·í•˜ì„¸ê°€ì™€ ìŠ¤í† ì–´','ì¹˜ì¿ ë°” ì‹ ìš”í…Œì´ ì—°ë°•'], spots:[['Morning Market',41.7736,140.7275],['Goryokaku',41.7968,140.7575],['Hachimanzaka',41.7657,140.7100],['Ropeway',41.7592,140.7030],['Shinyotei',41.7803,140.7875]]},
  {date:'4/30 THU', title:'í•˜ì½”ë‹¤í…Œ â†’ ë…¸ë³´ë¦¬ë² ì¸ ', text:`ì•„ì¹¨ ì‹ì‚¬ í›„ ì´ë™,
ë„ì°© í›„ ì˜¨ì²œ/ê°€ì´ì„¸í‚¤ ì¤‘ì‹¬ìœ¼ë¡œ í˜ì´ìŠ¤ ë‹¤ìš´.`, hero:'./day4-hero.jpg', meta:['ì•„ì¹¨: ìš°ë‹ˆ ë¬´ë¼ì¹´ë¯¸ í•˜ì½”ë‹¤í…Œ ë³¸ì ','ì¹˜ì¿ ë°” ì‹ ìš”í…Œì´ ì²´í¬ì•„ì›ƒ 11:00','ì´ë™ ì•½ 3ì‹œê°„','ì ì‹¬: íœ´ê²Œì†Œ','ë…¸ë³´ë¦¬ë² ì¸  í•˜ë‚˜ìœ ë¼ ì²´í¬ì¸ 14:00+','ì €ë…: ê°€ì´ì„¸í‚¤'], spots:[['Hakodate',41.7688,140.7288],['Noboribetsu Hanayura',42.4987,141.1446]]},
  {date:'5/1 FRI', title:'ë…¸ë³´ë¦¬ë² ì¸  â†’ CTS â†’ ì¸ì²œ', text:`ê·€êµ­ì¼.
ì²´í¬ì•„ì›ƒ í›„ ì§€ì˜¥ê³„ê³¡ì„ ì§§ê²Œ ë³´ê³  ê³µí•­ ì´ë™.`, hero:'./day5-hero.jpg', meta:['ì•„ì¹¨: í•˜ë‚˜ìœ ë¼ ì¼ì‹','í•˜ë‚˜ìœ ë¼ ì²´í¬ì•„ì›ƒ 10:00','ë…¸ë³´ë¦¬ë² ì¸  ì§€ì˜¥ê³„ê³¡','ê³µí•­ ë°˜ë‚©','KE766 CTS 15:05 â†’ ICN 18:10'], spots:[['Hanayura',42.4987,141.1446],['Jigokudani',42.4973,141.1428],['CTS',42.7752,141.6923],['Incheon',37.4602,126.4407]]}
];

const hakodateFoods=[
  {name:'ì´ì´ë‹¤ì•¼',type:'ì§•ê¸°ìŠ¤ì¹¸',time:'16:00~21:30',off:'ëª© íœ´ë¬´'},
  {name:'ìŠ¤í‚¤ì•¼í‚¤ ì•„ì‚¬ë¦¬ ë³¸ì ',type:'ìŠ¤í‚¤ì•¼í‚¤',time:'11:00~20:00',off:'ìˆ˜ íœ´ë¬´'},
  {name:'ì°¨ë¬´',type:'ì¹´ì´ì„¼ë™',time:'07:00~14:00',off:'ë³€ë™'},
  {name:'í†¤í‚¤ ë‹¤ì´ëª¬ì ',type:'ëˆì¹´ì¸ ',time:'11:00~20:30',off:'ì—°ì¤‘ë¬´íœ´'},
  {name:'íƒ€ì¹´í•˜ì‹œ(ì¥ì–´ë„ì½”ë¡œ)',type:'ì¥ì–´ë®ë°¥',time:'11:30~14:30 / 17:00~21:00',off:'í™” íœ´ë¬´'},
  {name:'ìš°ë‹ˆ ë¬´ë¼ì¹´ë¯¸',type:'ìš°ë‹ˆë™',time:'08:30~15:00',off:'ìˆ˜ íœ´ë¬´'}
];


function resolveFlightInfo(metaText, page){
  const m = metaText.match(/(KE\d{3})/i);
  if(!m) return null;
  const flight = m[1].toUpperCase();
  const dateLabel = page?.date || '';
  const route = metaText.includes('ICN') ? 'CTSâ†’ICN' : (metaText.includes('CTS') ? 'ICNâ†’CTS' : 'N/A');
  return { flight, dateLabel, raw: metaText, route };
}

function isTodayMatchDateLabel(dateLabel){
  const m = dateLabel.match(/(\d{1,2})\/(\d{1,2})/);
  if(!m) return false;
  const mm = Number(m[1]);
  const dd = Number(m[2]);
  const now = new Date();
  return (now.getMonth()+1)===mm && now.getDate()===dd;
}

async function showFlightGateInfo(info){
  if(!info) return;
  if(!isTodayMatchDateLabel(info.dateLabel)){
    alert(`âœˆï¸ ${info.flight} (${info.route})\n${info.dateLabel} ì¼ì •ì˜ ê²Œì´íŠ¸ëŠ” ë‹¹ì¼ì— í™•ì •ë©ë‹ˆë‹¤.\nì§€ê¸ˆì€ ì•„ì§ í™•ì • ì•ˆ ë˜ì–´ ìˆì–´ìš”.`);
    return;
  }

  const links = [
    `ëŒ€í•œí•­ê³µ ìš´í•­ì •ë³´: https://www.koreanair.com/kr/ko/booking/flight-status?searchText=${info.flight}`,
    `ì¸ì²œê³µí•­ ì¶œë„ì°©: https://www.airport.kr/ap/en/dep/depPasSchList.do`,
    `ì‹ ì¹˜í† ì„¸ ì¶œë„ì°©: https://www.hokkaido-airports.com/en/new-chitose/flight/`
  ].join('\n');

  alert(`âœˆï¸ ${info.flight} (${info.route})\n${info.dateLabel}\nê²Œì´íŠ¸ë¥¼ ì‹¤ì‹œê°„ ì¡°íšŒí–ˆì§€ë§Œ ì•„ì§ í™•ì • ì •ë³´ê°€ ì—†ê±°ë‚˜ í•­ê³µì‚¬ ë°˜ì˜ ì „ì…ë‹ˆë‹¤.\n\n${links}`);
}


function resolveCuisineInfo(metaText){
  if(!metaText.includes('ê°€ì´ì„¸í‚¤')) return null;
  return {
    name: 'ê°€ì´ì„¸í‚¤(æ‡çŸ³) ìš”ë¦¬',
    summary: 'ì œì²  ì‹ì¬ë£Œë¥¼ ì†ŒëŸ‰ì”© ìˆœì„œëŒ€ë¡œ ë‚´ëŠ” ì¼ë³¸ ì „í†µ ì½”ìŠ¤ ìš”ë¦¬ì…ë‹ˆë‹¤.',
    history: [
      'ê¸°ì›ì€ ë‹¤ë„(èŒ¶é“)ì˜ ì°¨íšŒ ìŒì‹(ì°¨ì¹´ì´ì„¸í‚¤)ìœ¼ë¡œ, ì†ë‹˜ ì ‘ëŒ€ìš© ê°„ì†Œí•œ ì‹ì‚¬ì—ì„œ ì¶œë°œí–ˆìŠµë‹ˆë‹¤.',
      'ì—ë„~ë©”ì´ì§€ ì‹œê¸°ì— ì—°íšŒÂ·ë£Œí…Œì´ ë¬¸í™”ì™€ ê²°í•©í•˜ë©° ì˜¤ëŠ˜ë‚ ì˜ ì½”ìŠ¤ í˜•íƒœë¡œ ë°œì „í–ˆìŠµë‹ˆë‹¤.',
      'í˜„ëŒ€ ê°€ì´ì„¸í‚¤ëŠ” ê³„ì ˆê°(æ—¬), ê·¸ë¦‡/í”Œë ˆì´íŒ…, ë§›ì˜ ê· í˜•ì„ ì¤‘ì‹œí•˜ëŠ” â€œì‹ë¬¸í™” ì˜ˆìˆ â€ë¡œ ì—¬ê²¨ì§‘ë‹ˆë‹¤.'
    ],
    points: ['ì „ì±„ â†’ êµ­ë¬¼ â†’ íšŒ/êµ¬ì´/ì°œ/íŠ€ê¹€ â†’ ì‹ì‚¬ â†’ ë””ì €íŠ¸ ìˆœìœ¼ë¡œ ì „ê°œë˜ëŠ” ê²½ìš°ê°€ ë§ìŒ', 'ë§›ë¿ ì•„ë‹ˆë¼ ì˜¨ë„Â·í–¥Â·ì‹ê°Â·ìƒ‰ê°ì˜ íë¦„ì´ í•µì‹¬', 'ë£Œì¹¸ ê°€ì´ì„¸í‚¤ëŠ” ì§€ì—­ ì‹ì¬ë£Œ(í•´ì‚°ë¬¼/ì‚°ì±„) ë°˜ì˜ ë¹„ì¤‘ì´ í¼']
  };
}

function showCuisineInfo(metaText){
  const c = resolveCuisineInfo(metaText);
  if(!c) return;
  const msg = [
    `ğŸ½ ${c.name}`,
    '',
    `â€¢ ì„¤ëª…: ${c.summary}`,
    '',
    'â€¢ ì—­ì‚¬:',
    ...c.history.map(v=>`  - ${v}`),
    '',
    'â€¢ í¬ì¸íŠ¸:',
    ...c.points.map(v=>`  - ${v}`)
  ].join('\\n');
  alert(msg);
}

function resolveSpotIndex(metaText, page){
  const dict = [
    ['CTS','CTS'],['ì¸ì²œ','Incheon'],['ì¹´ì´ í¬ë¡œí† ','KAI Poroto'],['ì•„ì¹´ë Œì¹´','Kanemori'],['ì¹˜ì¿ ë°”','Shinyotei'],
    ['ì•„ì¹¨ì‹œì¥','Morning Market'],['ê³ ë£Œì¹´ì¿ ','Goryokaku'],['í•˜ì¹˜ë§Œìì¹´','Hachimanzaka'],['ë¡œí”„ì›¨ì´','Ropeway'],
    ['í•˜ì½”ë‹¤í…Œ','Hakodate'],['í•˜ë‚˜ìœ ë¼','Hanayura'],['ì§€ì˜¥ê³„ê³¡','Jigokudani']
  ];
  for(const [k, token] of dict){
    if(metaText.includes(k)){
      const idx = page.spots.findIndex(s => s[0].includes(token));
      if(idx >= 0) return idx;
    }
  }
  return -1;
}

function buildMetaHtml(page){
  return (page.meta||[]).map((x, idx)=>{
    const flightInfo = resolveFlightInfo(x, page);
    const cuisineInfo = resolveCuisineInfo(x);
    const spotIdx = resolveSpotIndex(x, page);
    if(flightInfo){
      return `<li class="meta-item"><button class="meta-item-btn" data-flight-info="${encodeURIComponent(JSON.stringify(flightInfo))}"><strong>â€¢</strong> ${x}<span class="hint">í•­ê³µí¸/ê²Œì´íŠ¸ ë³´ê¸° âœˆï¸</span></button></li>`;
    }
    if(cuisineInfo){
      return `<li class="meta-item"><button class="meta-item-btn" data-cuisine="${encodeURIComponent(x)}"><strong>â€¢</strong> ${x}<span class="hint">ê°€ì´ì„¸í‚¤ ì •ë³´ ğŸ“–</span></button></li>`;
    }
    if(spotIdx >= 0){
      return `<li class="meta-item"><button class="meta-item-btn" data-spot-idx="${spotIdx}"><strong>â€¢</strong> ${x}<span class="hint">ì§€ë„ ë³´ê¸° â†—</span></button></li>`;
    }
    return `<li class="meta-item"><strong>â€¢</strong> ${x}</li>`;
  }).join('');
}

function bindMetaActions(){
  document.querySelectorAll('[data-spot-idx]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const idx = Number(el.getAttribute('data-spot-idx'));
      if(Number.isNaN(idx) || !markers[idx] || !map) return;
      const m = markers[idx];
      map.setView(m.getLatLng(), 13, {animate:true});
      m.openPopup();
      const mapBox = document.getElementById('map');
      if(mapBox) mapBox.scrollIntoView({behavior:'smooth', block:'center'});
    });
  });

  document.querySelectorAll('[data-flight-info]').forEach(el=>{
    el.addEventListener('click', async ()=>{
      const raw = el.getAttribute('data-flight-info');
      if(!raw) return;
      const info = JSON.parse(decodeURIComponent(raw));
      await showFlightGateInfo(info);
    });
  });

  document.querySelectorAll('[data-cuisine]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const raw = el.getAttribute('data-cuisine');
      if(!raw) return;
      showCuisineInfo(decodeURIComponent(raw));
    });
  });
}

function render(){
  document.getElementById('bg').style.display = cover ? 'none' : 'block';
  const el=document.getElementById('app');
  if(cover){
    el.innerHTML=`<section class="book cover-shell"><article class="cover-book"><img src="./sapporo-retro-main.jpg" alt="Sapporo editorial cover"/><div class="cover-body"><div class="kicker">Sapporo Visual Journal</div><h1>SAPPORO</h1><div class="sub">ì „ì²´ ì¼ì • + ë™ì„  ì§€ë„ + í•˜ì½”ë‹¤í…Œ ë§›ì§‘ ì •ë³´ë¥¼ í•œëˆˆì—</div><div class="nav" style="grid-template-columns:1fr"><button class="btn pri" onclick="openBook()">ì±… í¼ì¹˜ê¸°</button></div></div></article></section>`;
    return;
  }
  const p=pages[i];
  const metaHtml=buildMetaHtml(p);
  const foodHtml=hakodateFoods.map(f=>`<article class="food-card"><h4>${f.name}</h4><p>${f.type}</p><p>ì˜ì—… ${f.time}</p><p>${f.off}</p></article>`).join('');
  const [leadLine, ...restLines] = (p.text || '').split('\n');
  const restText = restLines.join('\n');
  el.innerHTML=`<section class="book spread ${dir==='prev'?'flip-prev':'flip-next'}"><div class="spread-grid"><article class="page-left"><div id="swipe" class="swipe-zone" style="--panel-bg:url('${p.hero}')"><div class="date">${p.date}</div><h2 class="title">${p.title}</h2><div class="body"><div class="sublead">${leadLine||''}</div><div class="body-rest">${restText||''}</div></div><ul class="meta-list">${metaHtml}</ul></div><div class="food-panel"><h3 class="food-title">Hakodate ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</h3><div class="food-scroll">${foodHtml}</div></div></article><article class="page-right"><div class="map-label">Route Map</div><div id="map" class="map"></div><div class="folio"><span>${i+1} / ${pages.length}</span><span>Sapporo South</span></div></article></div><div class="nav"><button class="btn" onclick="${i===0?'goCover()':'prev()'}">${i===0?'â† í‘œì§€':'â† ì´ì „'}</button><button class="btn" onclick="editPage()">ì œëª©/ì„¤ëª… ìˆ˜ì •</button><button class="btn pri" onclick="next()" ${i===pages.length-1?'disabled':''}>ë‹¤ìŒ â†’</button></div></section>`;
  bindSwipe();
  setTimeout(()=>{ drawMap(); bindMetaActions(); },0);
}

function editPage(){
  const p=pages[i];
  const t=prompt('ì œëª© ìˆ˜ì •',p.title); if(t!==null&&t.trim()) p.title=t.trim();
  const b=prompt('ì„¤ëª… ìˆ˜ì •',p.text.replace(/\n/g,' / ')); if(b!==null&&b.trim()) p.text=b.split(' / ').join('\n').trim();
  render();
}


function findRelatedMetaLines(spotName, page){
  const keyMap = [
    ['Incheon',['ì¸ì²œ','ICN']],
    ['CTS',['CTS','ì‹ ì¹˜í† ì„¸']],
    ['KAI Poroto',['ì¹´ì´ í¬ë¡œí† ','í¬ë¡œí† ']],
    ['Kanemori',['ì•„ì¹´ë Œì¹´','ì°½ê³ ','Kanemori']],
    ['Chikuba Shinyotei',['ì¹˜ì¿ ë°”','ì‹ ìš”í…Œì´']],
    ['Morning Market',['ì•„ì¹¨ì‹œì¥','ì°¨ë¬´']],
    ['Goryokaku',['ê³ ë£Œì¹´ì¿ ']],
    ['Hachimanzaka',['í•˜ì¹˜ë§Œìì¹´']],
    ['Ropeway',['ë¡œí”„ì›¨ì´']],
    ['Hakodate',['í•˜ì½”ë‹¤í…Œ']],
    ['Noboribetsu Hanayura',['í•˜ë‚˜ìœ ë¼']],
    ['Hanayura',['í•˜ë‚˜ìœ ë¼']],
    ['Jigokudani',['ì§€ì˜¥ê³„ê³¡']]
  ];
  const hit = keyMap.find(([token]) => spotName.includes(token));
  if(!hit) return [];
  const keys = hit[1];
  return (page.meta||[]).filter(line => keys.some(k => line.includes(k))).slice(0,3);
}

function buildSpotPopup(page, spot, idx){
  const related = findRelatedMetaLines(spot[0], page);
  const nav = `https://www.google.com/maps/dir/?api=1&destination=${spot[1]},${spot[2]}&travelmode=driving`;
  const map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot[0])}`;
  const street = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${spot[1]},${spot[2]}`;
  const relatedHtml = related.length
    ? `<ul style="margin:8px 0 0 16px;padding:0;font-size:12px;line-height:1.4;color:#334155">${related.map(v=>`<li>${v}</li>`).join('')}</ul>`
    : `<div style="margin-top:8px;font-size:12px;color:#64748b">ê´€ë ¨ ì¼ì • ì •ë³´ ì—†ìŒ</div>`;

  return `
    <div style="min-width:230px;max-width:280px">
      <div style="font-weight:700;font-size:13px;color:#1f2937">${idx+1}. ${spot[0]}</div>
      <div style="font-size:11px;color:#64748b;margin-top:2px">${page.date} Â· ${page.title}</div>
      ${relatedHtml}
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
        <a href="${nav}" target="_blank" style="padding:5px 8px;border-radius:999px;background:#2563eb;color:#fff;text-decoration:none;font-size:11px">ë„¤ë¹„</a>
        <a href="${map}" target="_blank" style="padding:5px 8px;border-radius:999px;border:1px solid #cbd5e1;color:#1f2937;text-decoration:none;font-size:11px">ì§€ë„</a>
        <a href="${street}" target="_blank" style="padding:5px 8px;border-radius:999px;border:1px solid #cbd5e1;color:#1f2937;text-decoration:none;font-size:11px">ìŠ¤íŠ¸ë¦¬íŠ¸ë·°</a>
      </div>
    </div>`;
}

function drawMap(){
  if(map){map.remove();map=null;}
  markers=[];
  const p=pages[i], m=document.getElementById('map'); if(!m) return;
  map=L.map(m,{zoomControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);
  const ll=p.spots.map(s=>[s[1],s[2]]);
  p.spots.forEach((s,idx)=>{
    const icon=L.divIcon({className:'',html:`<div style="width:25px;height:25px;border-radius:50%;background:#5f9ed0;color:#fff;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font:700 12px Inter">${idx+1}</div>`,iconSize:[25,25],iconAnchor:[12.5,12.5]});
    const marker = L.marker([s[1],s[2]],{icon}).addTo(map).bindPopup(buildSpotPopup(p, s, idx));
    markers.push(marker);
  });
  if(ll.length>1) L.polyline(ll,{color:'#5f9ed0',weight:4,opacity:.9}).addTo(map);
  map.fitBounds(L.latLngBounds(ll),{padding:[20,20]});
}

function bindSwipe(){
  const z=document.getElementById('swipe'); if(!z) return;
  z.addEventListener('touchstart',e=>{if(!e.touches||e.touches.length!==1)return;const t=e.touches[0];swipe.x=t.clientX;swipe.y=t.clientY;swipe.dx=0;swipe.dy=0;swipe.a=true;swipe.lock=false;},{passive:true});
  z.addEventListener('touchmove',e=>{if(!swipe.a||!e.touches||e.touches.length!==1)return;const t=e.touches[0];swipe.dx=t.clientX-swipe.x;swipe.dy=t.clientY-swipe.y;if(Math.abs(swipe.dy)>Math.abs(swipe.dx))swipe.lock=true;},{passive:true});
  z.addEventListener('touchend',()=>{if(!swipe.a)return;const ax=Math.abs(swipe.dx), ay=Math.abs(swipe.dy);if(!swipe.lock&&ax>=56&&ay<=42){swipe.dx<0?next():prev();}swipe.a=false;},{passive:true});
}

function openBook(){cover=false;render();}
function goCover(){cover=true;render();}
function prev(){if(i===0)return;dir='prev';i--;render();}
function next(){if(i===pages.length-1)return;dir='next';i++;render();}
window.openBook=openBook;window.goCover=goCover;window.prev=prev;window.next=next;window.editPage=editPage;
render();
</script>
</body>
</html>